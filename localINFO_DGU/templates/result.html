<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>대기질 조회 결과</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<style>
    body{font-family:Arial, sans-serif;margin:20px;background:#f5f5f5}
    .container{max-width:1400px;margin:0 auto;background:#fff;padding:30px;border-radius:10px;box-shadow:0 4px 6px rgba(0,0,0,.1)}
    .header{text-align:center;margin-bottom:30px}
    .stations{display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:20px;margin:30px 0}
    .station{background:#f8f9fa;padding:20px;border-radius:8px;border-left:6px solid #007bff}
    .pm-values{display:grid;grid-template-columns:1fr 1fr;gap:15px;margin-top:15px}
    .pm-item{text-align:center;padding:10px;background:#fff;border-radius:5px}
    .pm-value{font-size:1.2em;font-weight:700;color:#007bff}
    .tabs{text-align:center;margin:20px 0}
    .tab{padding:10px 22px;background:#e9ecef;border:0;border-radius:8px;font-weight:700;cursor:pointer;margin:0 5px}
    .tab.active{background:#007bff;color:#fff}
    .chart-container{margin:30px 0;padding:25px;background:#f8f9fa;border-radius:8px}
    .chart-wrapper{height:450px;margin:20px 0}
    .table-section{margin-top:10px}
    .table-card{background:#fbfbfb;border:1px solid #eee;border-radius:8px;padding:16px;margin-bottom:16px}
    .table-card h4{margin-bottom:8px}
    .table-card table{width:100%;border-collapse:collapse}
    .table-card th,.table-card td{border-bottom:1px solid #eee;padding:8px;text-align:center}
    .downloads{margin-top:8px}
    .download-btn{display:inline-block;margin-right:10px;padding:6px 10px;background:#007bff;color:#fff;border:none;border-radius:6px;cursor:pointer;text-decoration:none}
    .download-btn:hover{background:#0056b3}
    .back-link{text-align:center;margin:24px 0}
    .back-link a{background:#6c757d;color:#fff;padding:10px 20px;text-decoration:none;border-radius:5px}
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;background:#e9ecef;font-size:.85em;margin-left:6px}
    .chart-content{display:none}
    .chart-content.active{display:block}
    .distance-info{color:#666;font-size:0.9em;font-weight:bold;}
</style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1>대기질 조회 결과</h1>
        <h3>{{ place_name or address }}</h3>
        <p>검색어: {{ raw_query }} ({{ search_type }})</p>
    </div>

    <h2>실시간 대기질 현황 (거리 계산 적용)</h2>
    <div class="stations">
        {% for s in realtime %}
        <div class="station" style="border-left-color: {{ s.color }};">
            <h3>{{ loop.index }}순위 · {{ s.stationName }}
                <span class="badge">{{ s.network_type or '정보없음' }}</span>
            </h3>
            <p>{{ s.addr }}</p>
            <p><small>거리: <span class="distance-info">{{ s.distance_display }}</span> | 측정시간: {{ s.timestamp }}</small></p>
            <div class="pm-values">
                <div class="pm-item">
                    <div>PM10</div><div class="pm-value">{{ s.pm10_ug_m3 }}</div><div>㎍/㎥</div>
                </div>
                <div class="pm-item">
                    <div>PM2.5</div><div class="pm-value">{{ s.pm2_5_ug_m3 }}</div><div>㎍/㎥</div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <div class="tabs">
        <button class="tab active" onclick="switchChart('monthly')">월별 추세 (측정소별 레이어)</button>
        <button class="tab" onclick="switchChart('yearly')">연도별 추세 (측정소명 기준)</button>
    </div>

    <div class="chart-content active" id="monthly-chart">
        <div class="chart-container">
            <h2>월별 PM 농도 변화 (2025년 포함)</h2>
            <p style="text-align:center;color:#666;">실선: PM10 | 점선: PM2.5</p>
            <div class="chart-wrapper"><canvas id="monthlyCanvas"></canvas></div>
        </div>
    </div>

    <div class="chart-content" id="yearly-chart">
        <div class="chart-container">
            <h2>연도별 PM 농도 연평균 (2025년 포함)</h2>
            <p style="text-align:center;color:#666;">실선: PM10 | 점선: PM2.5</p>
            <div class="chart-wrapper"><canvas id="yearlyCanvas"></canvas></div>
        </div>
    </div>

    <h2>측정소별 데이터 테이블 & 다운로드</h2>
    <div class="table-section">
        {% for s in stations_with_display %}
        <div class="table-card">
            <h3>{{ loop.index }}순위 · {{ s.stationName }}
                <span class="badge">{{ s.network_type or '정보없음' }}</span>
                <span class="badge distance-info">거리 {{ s.distance_display }}</span>
            </h3>

            <h4>월별 (최근 12개월)</h4>
            <table>
                <thead><tr><th>연월</th><th>PM10</th><th>PM2.5</th></tr></thead>
                <tbody>
                {% for row in monthly_tables[s.stationName] %}
                    <tr>
                        <td>{{ row.get('month_label', '-') }}</td>
                        <td>{{ row.get('pm10_avg', '-') }}</td>
                        <td>{{ row.get('pm25_avg', '-') }}</td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
            <div class="downloads">
                <label for="monthInput_{{ loop.index }}" style="margin-right: 10px; font-weight: bold;">개월 수:</label>
                <input type="number" id="monthInput_{{ loop.index }}" value="12" min="1" max="60" style="margin-right: 10px; padding: 4px 8px; width: 60px;">
                <span style="margin-right: 10px; color: #666; font-size: 0.9em;">(1~60개월)</span>
                <button onclick="downloadMonthly('{{ s.stationName }}', {{ loop.index }})" class="download-btn">월별 CSV 다운로드</button>
            </div>

            <h4 style="margin-top:16px;">연도별 (최근 5년)</h4>
            <table>
                <thead><tr><th>연도</th><th>PM10</th><th>PM2.5</th></tr></thead>
                <tbody>
                {% for row in yearly_tables[s.stationName] %}
                    <tr>
                        <td>{{ row.get('year', '-') }}</td>
                        <td>{{ row.get('pm10_avg', '-') }}</td>
                        <td>{{ row.get('pm25_avg', '-') }}</td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
            <div class="downloads">
                <label for="yearInput_{{ loop.index }}" style="margin-right: 10px; font-weight: bold;">년 수:</label>
                <input type="number" id="yearInput_{{ loop.index }}" value="5" min="1" max="5" style="margin-right: 10px; padding: 4px 8px; width: 60px;">
                <span style="margin-right: 10px; color: #666; font-size: 0.9em;">(1~5년)</span>
                <button onclick="downloadYearly('{{ s.stationName }}', {{ loop.index }})" class="download-btn">연도별 CSV 다운로드</button>
            </div>
        </div>
        {% endfor %}
    </div>

    <div class="back-link"><a href="/">새로운 검색하기</a></div>
</div>

<script>
const chartData = {{ chart_data | tojson }};
let monthlyChart, yearlyChart;

function buildDatasets(group){
    const datasets = [];
    Object.keys(chartData[group]).forEach(st => {
        const d = chartData[group][st];
        datasets.push({
            label: st + ' PM10', data: d.pm10_data, borderColor: d.color,
            backgroundColor: d.color + '20', borderWidth: 3, fill: false, tension: 0.35, pointRadius: 4
        });
        datasets.push({
            label: st + ' PM2.5', data: d.pm25_data, borderColor: d.color,
            backgroundColor: d.color + '20', borderWidth: 3, borderDash: [6,6], fill: false, tension: 0.35, pointRadius: 4
        });
    });
    return datasets;
}

function initCharts(){
    const monthlyCtx = document.getElementById('monthlyCanvas').getContext('2d');
    const monthlyLabels = new Set();
    Object.values(chartData.monthly).forEach(v => v.labels.forEach(l => monthlyLabels.add(l)));
    monthlyChart = new Chart(monthlyCtx, {
        type: 'line',
        data: { labels: Array.from(monthlyLabels).sort(), datasets: buildDatasets('monthly') },
        options: { responsive:true, maintainAspectRatio:false, scales:{ y:{beginAtZero:true, title:{display:true, text:'PM 농도 (㎍/㎥)'}}, x:{title:{display:true, text:'연월'}} }, plugins:{legend:{position:'top'}} }
    });
    const yearlyCtx = document.getElementById('yearlyCanvas').getContext('2d');
    const yearlyLabels = new Set();
    Object.values(chartData.yearly).forEach(v => v.labels.forEach(l => yearlyLabels.add(l)));
    yearlyChart = new Chart(yearlyCtx, {
        type: 'line',
        data: { labels: Array.from(yearlyLabels).sort(), datasets: buildDatasets('yearly') },
        options: { responsive:true, maintainAspectRatio:false, scales:{ y:{beginAtZero:true, title:{display:true, text:'PM 농도 연평균 (㎍/㎥)'}}, x:{title:{display:true, text:'연도'}} }, plugins:{legend:{position:'top'}} }
    });
}

function switchChart(type){
    document.querySelectorAll('.tab').forEach(b=>b.classList.remove('active'));
    document.querySelectorAll('.chart-content').forEach(c=>c.classList.remove('active'));
    document.querySelector(`[onclick="switchChart('${type}')"]`).classList.add('active');
    document.getElementById(`${type}-chart`).classList.add('active');
}

function downloadMonthly(stationName, index) {
    const monthInput = document.getElementById(`monthInput_${index}`);
    let months = parseInt(monthInput.value);
    if (isNaN(months) || months < 1 || months > 60) {
        alert('개월 수는 1에서 60 사이의 숫자를 입력해주세요.');
        monthInput.focus();
        return;
    }
    const url = `/download/${encodeURIComponent(stationName)}/monthly?months=${months}`;
    window.open(url, '_blank');
}

function downloadYearly(stationName, index) {
    const yearInput = document.getElementById(`yearInput_${index}`);
    let years = parseInt(yearInput.value);
    if (isNaN(years) || years < 1 || years > 5) {
        alert('년 수는 1에서 5 사이의 숫자를 입력해주세요.');
        yearInput.focus();
        return;
    }
    const url = `/download/${encodeURIComponent(stationName)}/yearly?years=${years}`;
    window.open(url, '_blank');
}

document.addEventListener('DOMContentLoaded', initCharts);
</script>
</body>
</html>